# 白米5kg価格調査システム

## 概要

このシステムは、日本全国の白米5kgの価格情報をリアルタイムで調査し、テーブル形式で表示するウェブアプリケーションです。オンラインショップや実店舗、SNSなどから収集した最新の価格情報を一覧で確認することができます。
安売り情報を共有することによって、コメの売り惜しみや消費者の買い溜めにプレッシャーをかけて、コメ市場の流動性を高め適正価格の実現しましょう。

あなたの街の価格情報をX：旧Twitter等にアップいただき情報がより信頼感をますようにしたいと思います。積極的なご協力をお願いします。

![白米価格調査画面](https://medicalhealth.blob.core.windows.net/medicalhealth/ogp.png)

## 一般ユーザー向け説明

### 機能紹介

- **白米5kg価格調査**: 全国の白米5kgの販売価格をリアルタイムで調査
- **豊富な情報**: 都道府県、市町村、販売店名、銘柄、価格、特徴などの情報を表示
- **追加オプション**: 玄米、無洗米、オーガニック米などの追加条件も調査可能
- **SNS情報**: X（旧Twitter）やInstagramなどのSNSからの情報も含む
- **カスタム調査**: 独自の調査条件を指定することも可能

### 使用方法

1. **価格調査タブ**:
   - デフォルトの調査内容でそのまま「調査開始」ボタンをクリックするか、独自の調査内容を入力できます
   - 「玄米も調査」「無洗米も調査」などの追加オプションを選択できます
   - 「調査開始」ボタンをクリックすると調査が始まり、結果がテーブル形式で表示されます
   - 画面上部に調査結果の件数が表示されます（例：「調査結果: 24件」）

2. **追加質問タブ**:
   - 米に関する具体的な質問（例：「カリフォルニア米の関税について教えてください」）を入力できます
   - 「質問する」ボタンをクリックすると、質問に対する回答が表示されます

### 調査結果の見方

- **テーブル形式**: 調査結果は見やすいテーブル形式で表示されます
- **情報源**: SNSからの情報は「(X情報)」などと表示されます
- **多様な情報**: 地域や銘柄、販売チャネルの多様な情報を20件以上表示します
- **特徴**: 産年、等級、栽培方法などの特徴も確認できます

## システム開発者向け説明

### システム構成

- **フロントエンド**: HTML, CSS, JavaScript (Bootstrap 5.3.0)
- **バックエンド**: Azure Functions (TypeScript)
- **AI**: Anthropic Claude API

### 主要ファイル

- `ricesurvey.html`: フロントエンドのUIとJavaScriptロジック
- `httpTrigger1.ts`: Azure Functionsのバックエンドコード
- `onigiri.jpg` / `onigiri.ico`: アプリケーションのイメージ・アイコンファイル

### API仕様

#### リクエスト形式

```json
{
  "message": "白米5kgの値段調査をネット情報から行ってください...",
  "survey_type": "initial_survey"
}
```

- `message`: 調査内容または質問内容
- `survey_type`: 「initial_survey」(価格調査) または「additional_question」(追加質問)

#### レスポンス形式

```json
{
  "success": true,
  "response": "調査結果のテキスト（マークダウン形式）",
  "count": 24
}
```

- `success`: 処理の成功/失敗
- `response`: 調査結果のテキスト（マークダウン形式）
- `count`: 調査結果の件数
- `error`: エラーが発生した場合のエラーメッセージ

### 重要なセキュリティ注意事項

1. **Azure Function キーの取り扱い**:
   - Function キーをクライアントサイドのHTMLや JavaScript内に直接記述しないでください
   - Function キーは環境変数やサーバーサイドの設定で管理し、CORS設定を適切に行ってください
   - 公開リポジトリにFunction キーを含むコードをコミットしないでください

2. **CORS (Cross-Origin Resource Sharing)設定**:
   - Azure Functionsの設定でCORSを適切に構成し、許可されたオリジンからのリクエストのみを受け付けるようにしてください
   - Function Keyを使用する場合は、サーバーサイドのプロキシを経由するか、認証済みクライアントのみがアクセスできるように設計してください

3. **クライアント認証の実装**:
   - 必要に応じて、JWT, OAuth などの認証方式を導入し、権限のないユーザーが API にアクセスできないようにしてください

### 主要な実装ポイント

1. **システムプロンプト設計**:
   - Claude APIに送信するシステムプロンプトは、多様で詳細な結果を得るために重要です
   - 少なくとも20件以上の結果が返されるように明示的に指示しています

2. **MCP (Model Context Protocol) 最適化**:
   - `<MCP:instructions>`, `<MCP:context>`, `<MCP:expected_output>` タグを使用して、より精度の高い結果を得ています

3. **パラメータチューニング**:
   - `temperature`, `top_p`, `top_k` などのパラメータを調整して、結果の多様性を確保しています

4. **調査件数カウント機能**:
   - レスポンスに含まれるテーブルの行数をカウントして、調査結果の件数を自動的に計算します
   - フロントエンドで「調査結果: XX件」のように表示できます

5. **エラーハンドリング**:
   - リクエスト検証、例外処理など、堅牢なエラーハンドリングを実装しています

### 拡張・カスタマイズ方法

1. **モデル変更**:
   ```typescript
   const MODEL: string = process.env.CLAUDE_MODEL || 'claude-3-5-sonnet-20240620';
   ```
   - 新しいモデルに更新する場合は、環境変数または上記の値を変更してください

2. **システムプロンプト変更**:
   ```typescript
   const SYSTEM_PROMPT: string = `あなたは米価格調査の専門家です。...`;
   ```
   - システムプロンプトを調整して、異なる情報や形式の結果を得ることができます

3. **フロントエンドカスタマイズ**:
   - `ricesurvey.html` の CSS や JavaScript を編集して、UIや動作をカスタマイズできます

4. **追加オプション**:
   - フロントエンドの追加オプションタグを編集して、新しいオプションを追加できます

### デプロイ方法

1. Azure Functionsへのデプロイ:
   ```bash
   npm install -g azure-functions-core-tools@4
   func azure functionapp publish pricesurvey
   ```

2. 環境変数の設定:
   - `ANTHROPIC_API_KEY`: Anthropic Claude APIキー
   - `CLAUDE_MODEL`: 使用するClaudeモデル

## トラブルシューティング

- **結果が少ない場合**: システムプロンプトの指示を強化するか、`max_tokens` を増やしてみてください
- **APIエラー**: Azure Functionsのログを確認し、Anthropic APIキーが正しく設定されているか確認してください
- **表示の問題**: フロントエンドのマークダウン変換関数 `convertMarkdownToHtml` を確認・修正してください

## リンク・参考資料

- [Anthropic Claude API ドキュメント](https://docs.anthropic.com/)
- [Azure Functions ドキュメント](https://docs.microsoft.com/ja-jp/azure/azure-functions/)
- [Bootstrap ドキュメント](https://getbootstrap.com/docs/5.3/)

## ライセンス

MIT License

---

※このアプリケーションは情報提供を目的としており、表示される価格情報は実際の販売価格と異なる場合があります。
